<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Médicos - Medfy</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<div class="container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <span class="logo-text">Medfy</span>
            </div>
            <button class="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <nav class="sidebar-nav" role="navigation" aria-label="Sidebar Navigation">
                <a href="{{ url_for('index_page') }}" class="nav-item" aria-current="page">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('view_paciente') }}" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Pacientes</span>
                </a>
                <a href="{{ url_for('view_medico') }}" class="nav-item active">
                    <i class="fas fa-user-md"></i>
                    <span>Médicos</span>
                </a>
                <a href="{{ url_for('convenios') }}" class="nav-item">
                    <i class="fas fa-id-card"></i>
                    <span>Convênios</span>
                </a>
                <a href="{{ url_for('agendamentos') }}" class="nav-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Agendamentos</span>
                </a>
            </nav>
        <div class="sidebar-footer">
            <button class="menu-button">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
            </button>
        </div>
    </aside>

    <div class="main-content">
        <header class="header">
            <div class="back-button-container">
                <a href="{{ url_for('index_page') }}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    <span class="hide-mobile">Voltar</span>
                </a>
            </div>
            <div class="header-actions">
                <button class="icon-button">
                    <i class="fas fa-bell"></i>
                </button>
                <div class="avatar">AD</div>
            </div>
        </header>

        <main class="content">
            <div class="page-header">
                <div></div>
                <a href="{{ url_for('view_medico_cadastro') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Novo Médico
                </a>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Lista de Médicos</h2>
                        <p class="card-description">Gerencie todos os médicos cadastrados no sistema</p>
                    </div>
                </div>
                <div class="card-content">
                    <div class="table-actions">
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="search" placeholder="Buscar médico..." id="table-search" />
                        </div>
                        <button class="icon-button"><i class="fas fa-filter"></i></button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>CRM</th>
                                    <th>Turno</th>
                                    <th class="hide-mobile">Telefone</th>
                                    <th class="hide-tablet">Email</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="medicos-body">
                                <!-- Dados serão carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    // Função para carregar os médicos da API
    async function carregarMedicos() {
        try {
            const response = await fetch('/medico/');
            if (!response.ok) {
                throw new Error('Erro ao carregar médicos');
            }

            const medicos = await response.json();
            const tbody = document.getElementById('medicos-body');
            tbody.innerHTML = '';

            if (medicos.error) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">${medicos.error}</td></tr>`;
                return;
            }

            if (medicos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum médico cadastrado</td></tr>';
                return;
            }

            medicos.forEach(medico => {
                const tr = document.createElement('tr');

                // Formatar telefone se existir
                const telefoneFormatado = medico.telefone ?
                    formatarTelefone(medico.telefone) : 'Não informado';

                tr.innerHTML = `
                    <td class="highlight">
                        <a href="/medico_info?id=${medico.id_med}">
                            ${medico.nome_med || 'Não informado'}
                        </a>
                    </td>
                    <td>${medico.crm || 'Não informado'}</td>
                    <td>${medico.turno || 'Não informado'}</td>
                    <td class="hide-mobile">${telefoneFormatado}</td>
                    <td class="hide-tablet">${medico.email_med || 'Não informado'}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="/medico_info?id=${medico.id_med}" class="btn-icon">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn-icon btn-delete" data-id="${medico.id_med}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(tr);
            });

            // Adicionar event listeners para os botões de deletar
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idMedico = e.currentTarget.getAttribute('data-id');
                    deletarMedico(idMedico);
                });
            });

        } catch (error) {
            console.error('Erro:', error);
            const tbody = document.getElementById('medicos-body');
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">Erro ao carregar médicos: ${error.message}</td></tr>`;
        }
    }

    // Função para deletar médico
    async function deletarMedico(idMedico) {
        if (!confirm('Tem certeza que deseja excluir este médico?')) {
            return;
        }

        try {
            const response = await fetch(`/medico/${idMedico}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Erro ao deletar médico');
            }

            alert(result.message || 'Médico deletado com sucesso');
            carregarMedicos(); // Recarregar a lista
        } catch (error) {
            console.error('Erro:', error);
            alert(`Erro ao deletar médico: ${error.message}`);
        }
    }

    // Função para formatar telefone
    function formatarTelefone(telefone) {
        // Remove tudo que não for dígito
        const numeros = telefone.replace(/\D/g, '');

        // Formatação para (XX) XXXXX-XXXX
        if (numeros.length === 11) {
            return numeros.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }

        // Formatação para (XX) XXXX-XXXX
        if (numeros.length === 10) {
            return numeros.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        }

        // Retorna o original se não for possível formatar
        return telefone;
    }

    // Função para filtrar a tabela
    function filtrarTabela(termo) {
        const linhas = document.querySelectorAll('#medicos-body tr');
        termo = termo.toLowerCase();

        linhas.forEach(linha => {
            const textoLinha = linha.textContent.toLowerCase();
            linha.style.display = textoLinha.includes(termo) ? '' : 'none';
        });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', carregarMedicos);

    document.getElementById('table-search').addEventListener('input', (e) => {
        filtrarTabela(e.target.value);
    });

    document.getElementById('header-search').addEventListener('input', (e) => {
        filtrarTabela(e.target.value);
    });
</script>

<style>
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-icon {
        background: none;
        border: none;
        color: var(--gray-500);
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background-color: var(--gray-100);
        color: var(--gray-700);
    }

    .btn-delete:hover {
        color: var(--red-800);
        background-color: var(--red-100);
    }

    .text-center {
        text-align: center;
    }
</style>

</body>
</html>